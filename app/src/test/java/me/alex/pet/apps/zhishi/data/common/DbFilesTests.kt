package me.alex.pet.apps.zhishi.data.common

import org.junit.jupiter.api.Test
import strikt.api.expectThat
import strikt.api.expectThrows
import strikt.assertions.isEqualTo
import java.io.ByteArrayInputStream

class DbFilesTests {

    @Test
    fun `correctly reads database version 1`() {
        val inputStream = ByteArrayInputStream(FAKE_DB_BYTES_V1)

        val version = DbFiles.readDatabaseVersion(inputStream)

        expectThat(version).isEqualTo(1)
    }

    @Test
    fun `correctly reads database version 2,147,483,647`() {
        val inputStream = ByteArrayInputStream(FAKE_DB_BYTES_V2147483647)

        val version = DbFiles.readDatabaseVersion(inputStream)

        expectThat(version).isEqualTo(2147483647)
    }

    @Test
    fun `throws on database version read if database file is shorter than 64 bytes`() {
        val inputStream = ByteArrayInputStream(FAKE_61_BYTES)

        expectThrows<DbFiles.VersionReadException> {
            DbFiles.readDatabaseVersion(inputStream)
        }
    }

    @Test
    fun `throws on database version read if database file is shorter than 60 bytes`() {
        val inputStream = ByteArrayInputStream(FAKE_59_BYTES)

        expectThrows<DbFiles.VersionReadException> {
            DbFiles.readDatabaseVersion(inputStream)
        }
    }

    companion object {
        private val FAKE_DB_BYTES_V1 = byteArrayOf(
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x01.b,
        ) //                                ------------------------------  <-- bytes 60-63

        private val FAKE_DB_BYTES_V2147483647 = byteArrayOf(
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x7F.b, 0xFF.b, 0xFF.b, 0xFF.b,
        ) //                                ------------------------------  <-- bytes 60-63

        private val FAKE_61_BYTES = byteArrayOf(
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x7F.b, 0xFF.b
        ) //                                --------------  <-- bytes 60-61

        private val FAKE_59_BYTES = byteArrayOf(
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b, 0x00.b,
            0x00.b, 0x00.b, 0x00.b,
        )
    }
}

private val Int.b get() = this.toByte()